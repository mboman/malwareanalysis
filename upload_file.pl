#!/usr/bin/perl

# Stop us from shooting outselves in the foot
use strict;
use warnings;

# We are storing the configuration file in INI format
use Config::IniHash;
use Dir::Self;
use File::Temp qw( tempdir );
use File::Basename;

# Our own helper package
use MDBUtils;
use MDBAWS;

# Local sub routines
sub process_file;

# Configuration
my $config = MDBUtils::get_config();
print "DEBUG: Read configuration file\n";

# Our variables..
my $metadata;
my $response;

$metadata->{'rcvd_DateTime'} = DateTime->now();
$metadata->{'rcvd_DateTime'}->set_time_zone("GMT");

my $filename = $ARGV[0];
process_file($filename);

exit;    # END OF PROGRAM

# Process the file
sub process_file {
    my $filename = shift
      or die("FUNCTION USAGE: process_file( filename );\n");

    print "DEBUG: process_file( " . $filename . " );\n";

    my $filetype = MDBUtils::filetype($filename);

    # What kind of content do we have?
    for ($filetype) {
        if (/executable/) {
            MDBAWS::store_sample( $filename, $metadata );
        }
        elsif (/PDF/) {
            MDBAWS::store_sample( $filename, $metadata );
        }
        elsif (/Zip/) {
            my @filelist = MDBUtils::extract_archive_zip($filename);
            foreach my $file (@filelist) {
                process_file($file);
            }
        }
        elsif (/RAR/) {
            my @filelist = MDBUtils::extract_archive_rar($filename);
            foreach my $file (@filelist) {
                process_file($file);
            }
        }
        elsif ( $filename =~ m/\.com$/i ) {
            MDBAWS::store_sample( $filename, $metadata );
        }
        else {
            print "DEBUG: Unknown filetype: " . $filetype . "\n";
            print "DEBUG: Need to send sample for manual analysis!\n";
        }
    }
}
