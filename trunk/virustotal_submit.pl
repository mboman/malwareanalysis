#!/usr/bin/perl

use strict;
use warnings;

use JSON;
use LWP::Simple;
use LWP::UserAgent;
use Digest::MD5;

sub vt_check_file($) {
    my $vt_id = shift;
    init_vt($vt_id);
    my $res     = get( "http://www.virustotal.com/analisis/" . $vt_id );
    my $pattern = '<div id="status_porcentaje">Result: <span id="porcentaje"><span style="color:red;">';
    if ( $res =~ /$pattern(\d+)\/(\d+)<\/span>/ ) {
        return ($1,$2);
    }
    return 0;
}

sub vt_send_file($$) {
    my $filename = shift;
    my $vt_id    = shift;
    my $response;
    my $header;
    my $ua = LWP::UserAgent->new();
    $ua->agent(
        'Mozilla/5.0 (compatible; MSIE 5.5; Windows 98; Win 9x; Windows 2000)'
    );
    my $url =
      "https://www.virustotal.com/vt/en/recepcion?" . get_vt_session_id();
    my $res = $ua->post(
        $url,
        Content_Type => 'form-data',
        Content      => [ archivo => ["$filename"] ]
    );

    $res = "";
    while ( not $res =~ /^\[\"TERMINADO\"/ ) {
        $res = vt_ado( $vt_id, 0, 0 );
        sleep(5);
    }
    my $obj = decode_json($res);

    my $vendors        = $obj->[2];
    my $num_detections = 0;
    my $num_engines = 0;

    foreach my $vendor (@$vendors) {
        if ( $vendor->[3] ne '-' ) {
            $num_detections++;
        }
	$num_engines++;
    }
    return ($num_detections, $num_engines);
}

sub get_vt_id_by_md5($) {
    my $md5 = shift;
    my $ua = LWP::UserAgent->new;
    my $req =
      HTTP::Request->new(
        POST => "https://www.virustotal.com/vt/en/consultamd5" );
    $req->content_type('application/x-www-form-urlencoded');
    $req->content( 'hash=' . $md5 . '&x=1&y=1' );
    my $res = $ua->request($req);
    if ( $res->{_headers}->{location} =~ /\/resultado.html\?(.*)/ ) {
        return $1;
    }
}

sub calc_md5($) {
    my $filename = shift;
    open FILE, $filename;
    binmode FILE;
    my $md5 = Digest::MD5->new->addfile(*FILE)->hexdigest;
    close FILE;
    return $md5;
}

sub init_vt($) {
    my $vt_id = shift;

    return get( "https://www.virustotal.com/vt/en/reanaliza?" . $vt_id );
}

sub vt_ado($$) {
    my $vt_id   = shift;
    my $counter = shift;
    my $command = shift;

    return get( "https://www.virustotal.com/vt/en/resultado?" 
          . $vt_id . "-" 
          . $counter . "-"
          . $command );
}

sub get_vt_session_id() {
    return get("https://www.virustotal.com/vt/en/identificador");
}

my $filename       = $ARGV[0] or die "arg!\n";
my $md5            = calc_md5($filename);
my $vt_id          = get_vt_id_by_md5($md5);
my ($num_detections, $num_engines) = vt_check_file($vt_id);

if ( $num_detections < 1 ) {
    ($num_detections, $num_engines) = vt_send_file( $filename, $vt_id );
}
print "detections: " . $num_detections . "\n";
print "engines: " . $num_engines . "\n";
my $percent = ($num_detections / $num_engines) * 100;
print "( " . $percent . "% )\n";

