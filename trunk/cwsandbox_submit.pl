#!/usr/bin/perl
use strict;
use warnings;

# We are storing the configuration file in INI format
use Config::IniHash;
use Dir::Self;

use MDBCWSandbox;
use MDBAWS;

my $config = ReadINI( __DIR__ . "/config.ini" );
my $queue  = MDBAWS::sqs_get_queue("cwsandbox");

while (1) {
    my $msg = MDBAWS::sqs_get_message($queue);

    if ( !defined($msg) ) {
        print "DEBUG: No tickets in the queue, sleeping...\n";
        sleep(300);
    }
    else {
        my $metadata = MDBAWS::sdb_get_metadata( $msg->MessageBody() );

        if ( defined( $metadata->{'sha256'} ) ) {
            my $file = MDBAWS::s3_get_file( $config->{'aws'}->{'bucketname'},
                $metadata->{'zipname'} );

            if ( !defined( $metadata->{'cwsandbox_detailspage'} ) ) {
                $metadata->{'cwsandbox_detailspage'} =
                  MDBCWSandbox::CWSubmitSample($file);
            }

            if ( !defined( $metadata->{'cwsandbox_reportpage'} ) ) {
                $metadata->{'cwsandbox_reportpage'} =
                  MDBCWSandbox::GetCWXMLReportURL(
                    $metadata->{'cwsandbox_detailspage'} );

                MDBAWS::sqs_put_queue( "cwsandbox", $msg->MessageBody() );
            }
            MDBAWS::sdb_put_metadata($metadata);
            unlink($file);
        }
        $queue->DeleteMessage( $msg->ReceiptHandle() );
    }
}
